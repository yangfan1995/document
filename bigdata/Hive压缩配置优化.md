# Hive压缩、文件配置优化

## 背景

### 文件压缩的意义

文件压缩优点体现两个方面

1. 减少文件的物理存储空间，数据大的情况下适当的压缩方式可以减少很多存储空间。
2. 减小文件在网络上的网络传输开销，减少传输时间。在大数据的MapReduce条件下，job间通信频繁，网络传输频繁，对中间数据结果进行压缩，可以缩短大量的时间。

一般MR(MapReduce)操作都是IO密集的，也就是磁盘的读写比较频繁，相对来说CPU的使用率不是特别高，而压缩刚好是CPU密集操作。

### 行式存储和列式存储

传统型数据库是采用行存储形式，所有的数据都会放在一行上，便于进行更新添加操作删除等操作。最小的操作单元是行，所以想要读取某一列的数据时也会将所有数据读取出来。所有的数据在磁盘上线性存储的。

| id   | user_id | user_name |
| ---- | ------- | --------- |
| 1    | 0001    | 张三      |
| 2    | 0002    | 李四      |
| 3    | 0003    | 王五      |

*行存储*磁盘上的存储为`1,0001,张三`->`2,0002,李四`->`3,0003,王五`

*列存储*磁盘上的存储为`1,2,3`->`0001,0002,0003`->`张三,李四,王五`

#### 嵌套数据模型

## 压缩算法

| 压缩格式 | codec类     | 算法    | 扩展名  | 多文件 | splitable | native | 工具  | hadoop自带 | 压缩速度 | 压缩比率 |
| -------- | ----------- | ------- | ------- | ------ | --------- | ------ | ----- | ---------- | -------- | -------- |
| gzip     | GzipCodec   | deflate | .gz     | 否     | 否        | 是     | gzip  | 是         | 中       | 中       |
| bzip2    | Bzip2Codec  | bzip2   | .bz2    | 是     | 是        | 否     | bzip2 | 是         | 慢       | 小       |
| lzo、Lz4 | LzopCodec   | lzo     | .lzo    | 否     | 是        | 是     | lzop  | 否         | 快       | 大       |
| snappy   | SnappyCodec | snappy  | .snappy | 否     | 否        | 是     | 无    | 否         | 快       | 大       |

## 常用文件格式

| 存储类型 | 是否可分         | 是否默认压缩 | 压缩格式 | 支持的压缩格式   | 存储结构 | 优缺点                                                       |
| -------- | ---------------- | ------------ | -------- | ---------------- | -------- | ------------------------------------------------------------ |
| TextFile | 是，压缩后不可分 | 否           |          | Gzip             | all      | 反序列化过程中，必须逐个字符判断是不是分隔符和行结束符，因此反序列化开销会比SequenceFile高几十倍 |
| ORCFile  | 是               | 是           | zlib     | zlib,snappy,none | 行列存储 | 性能优良，支持列查询，update/delete                          |
| Parquet  | 是               | 是           | Snappy   | Snappy、Gzip     | 列存储   | 性能优良                                                     |

### TextFile格式



### Parquet格式

### Orc格式

## 压缩优化

### 文件压缩

### 中间过程结果压缩

## 优化总结
